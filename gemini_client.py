import google.generativeai as genai
from config import GEMINI_API_KEY
import json

class GeminiClient:
    def __init__(self):
        genai.configure(api_key=GEMINI_API_KEY)
        # Используем проверенную рабочую модель
        self.model = genai.GenerativeModel('models/gemini-2.5-flash')
    
    def get_system_prompt(self, user_data):
        """Генерация системного промпта на основе данных пользователя"""
        
        # Определяем персонажа на основе пола
        if user_data.get('gender') == 'male':
            coach_persona = """
            Ты — Ронни Коулман (Ronnie Coleman), 8-кратный "Мистер Олимпия". 
            Стиль: мощный, харизматичный, мотивирующий ("Light weight, baby!", "Yeah buddy!"), 
            упор на силовые показатели и экстремальную массу.
            """
        else:
            coach_persona = """
            Ты — Дженет Лайог (Janet Layug), чемпионка "Bikini Olympia". 
            Стиль: профессиональный, эстетичный, фокус на пропорциях, 
            качестве кожи и мышечном тонусе.
            """
        
        system_prompt = f"""
        IFBB Pro Dual-Coach AI
        
        Role: Ты — гибридный ИИ-ассистент, объединяющий двух легенд мирового бодибилдинга.
        
        {coach_persona}
        
        Goal: Создавать индивидуальные программы тренировок и питания, вести пользователя 
        от новичка до уровня подготовки к турнирам "Olympia" или "IFBB World Championships".
        
        Данные пользователя:
        - Пол: {user_data.get('gender', 'не указан')}
        - Возраст: {user_data.get('age', 'не указан')}
        - Рост: {user_data.get('height', 'не указан')} см
        - Вес: {user_data.get('weight', 'не указан')} кг
        - Замеры: {user_data.get('measurements', {})}
        - Уровень: {user_data.get('fitness_level', 'не указан')}
        - Цель: {user_data.get('goal', 'не указана')}
        - Локация: {user_data.get('location', 'не указана')}
        - Тренировок в неделю: {user_data.get('workouts_per_week', 'не указано')}
        - Травмы: {user_data.get('injuries', 'нет')}
        
        Core Capabilities:
        1. Training Management: Генерируй тренировочный план на 4 недели (Microcycle). 
           Используй принципы прогрессии нагрузок, периодизации и метаболического отклика.
        
        2. Nutrition & Calories: Рассчитывай КБЖУ на основе формулы Миффлина-Сан Жеора 
           с поправкой на коэффициент активности и цель.
        
        3. Sports Supplements: Рекомендуй только доказанные добавки исходя из дефицитов и целей.
        
        Constraints:
        - Никаких общих советов. Только конкретные упражнения, количество подходов и повторений.
        - Соблюдай тон выбранного персонажа, но сохраняй научную точность.
        - НЕ используй символы *, _, `, [, ] в ответах - они вызывают ошибки в Telegram.
        - Используй простое текстовое форматирование без Markdown.
        - В конце каждого ответа — мотивирующая цитата в стиле персонажа.
        
        Отвечай на русском языке.
        """
        
        return system_prompt
    
    def generate_response(self, user_data, user_message):
        """Генерация ответа от Gemini"""
        try:
            system_prompt = self.get_system_prompt(user_data)
            
            # Формируем полный промпт
            full_prompt = f"{system_prompt}\n\nВопрос пользователя: {user_message}"
            
            # Генерируем ответ
            response = self.model.generate_content(full_prompt)
            
            return response.text
            
        except Exception as e:
            error_msg = str(e)
            if "404" in error_msg or "not found" in error_msg:
                return ("Извините, возникла проблема с ИИ-моделью. "
                       "Попробуйте позже или обратитесь к администратору для обновления настроек.")
            elif "quota" in error_msg.lower() or "limit" in error_msg.lower():
                return ("Превышен лимит запросов к ИИ. Попробуйте через несколько минут.")
            else:
                return f"Произошла ошибка при генерации ответа. Попробуйте переформулировать вопрос."
    
    def generate_workout_plan(self, user_data):
        """Генерация плана тренировок"""
        workouts_per_week = user_data.get('workouts_per_week', 3)
        
        prompt = f"""
        Создай детальный план тренировок на 4 недели в простом текстовом формате.
        
        ВАЖНО: Пользователь может тренироваться {workouts_per_week} раз в неделю.
        
        Требования:
        - Создай программу именно на {workouts_per_week} тренировки в неделю
        - Укажи конкретные упражнения, подходы, повторения
        - Учти уровень подготовки и цель пользователя
        - Добавь прогрессию нагрузок по неделям
        - Включи разминку и заминку
        - Если локация "Дом" - используй упражнения с минимальным инвентарем
        - НЕ используй символы *, _, `, [, ] в ответе
        - Используй простое текстовое форматирование
        
        Рекомендации по сплиту:
        - 2 тренировки: Full Body (все группы мышц за тренировку)
        - 3 тренировки: Upper/Lower/Full Body или Push/Pull/Legs
        - 4 тренировки: Upper/Lower/Upper/Lower или Push/Pull/Legs/Full Body
        - 5+ тренировок: Push/Pull/Legs/Upper/Lower или классический сплит
        
        Формат ответа должен содержать:
        1. Общие принципы программы
        2. Недельный сплит на {workouts_per_week} тренировки
        3. Детальные тренировки по дням
        4. Рекомендации по прогрессии
        5. Дни отдыха и восстановления
        """
        
        try:
            return self.generate_response(user_data, prompt)
        except Exception as e:
            return ("Не удалось создать план тренировок. "
                   "Попробуйте позже или обратитесь к тренеру лично.")
    
    def calculate_nutrition(self, user_data):
        """Расчет питания и КБЖУ"""
        prompt = """
        Рассчитай индивидуальный план питания с точными значениями КБЖУ в простом текстовом формате.
        
        Используй:
        - Формулу Миффлина-Сан Жеора для базового метаболизма
        - Коэффициент активности на основе тренировочного режима
        - Поправку на цель (набор массы/сушка/поддержание)
        
        Предоставь:
        1. Точные цифры КБЖУ в день
        2. Распределение по приемам пищи
        3. Примерное меню на день
        4. Рекомендации по времени приема пищи относительно тренировок
        
        НЕ используй символы *, _, `, [, ] в ответе. Используй простое текстовое форматирование.
        """
        
        try:
            return self.generate_response(user_data, prompt)
        except Exception as e:
            return ("Не удалось рассчитать план питания. "
                   "Попробуйте позже или обратитесь к диетологу.")
    
    def recommend_supplements(self, user_data):
        """Рекомендации по спортивному питанию"""
        prompt = """
        Порекомендуй спортивные добавки на основе цели и уровня подготовки в простом текстовом формате.
        
        Включи только научно обоснованные добавки:
        - Креатин моногидрат
        - Протеин (сывороточный/казеиновый)
        - Аминокислоты (BCAA/EAA)
        - Витаминно-минеральные комплексы
        - Омега-3
        
        Для каждой добавки укажи:
        1. Дозировку
        2. Время приема
        3. Ожидаемый эффект
        4. Приоритет (обязательно/желательно/опционально)
        
        НЕ используй символы *, _, `, [, ] в ответе. Используй простое текстовое форматирование.
        """
        
        try:
            return self.generate_response(user_data, prompt)
        except Exception as e:
            return ("Не удалось подобрать спортивное питание. "
                   "Обратитесь к специалисту по спортивному питанию.")