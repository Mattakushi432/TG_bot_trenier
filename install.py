#!/usr/bin/env python3
"""
Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ğ¾Ñ‚Ğ°
"""

import os
import sys
import subprocess
import shutil

def print_header():
    """Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°"""
    print("ğŸ†" + "=" * 48 + "ğŸ†")
    print("    IFBB Pro Dual-Coach AI - Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°")
    print("ğŸ†" + "=" * 48 + "ğŸ†")
    print()

def check_python_version():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ĞµÑ€ÑĞ¸Ğ¸ Python"""
    print("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ĞµÑ€ÑĞ¸Ğ¸ Python...")
    
    if sys.version_info < (3, 8):
        print("âŒ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Python 3.8 Ğ¸Ğ»Ğ¸ Ğ²Ñ‹ÑˆĞµ!")
        print(f"   Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ: {sys.version}")
        return False
    
    print(f"âœ… Python {sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")
    return True

def install_dependencies():
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹"""
    print("\nğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹...")
    
    try:
        subprocess.check_call([
            sys.executable, "-m", "pip", "install", "-r", "requirements.txt"
        ])
        print("âœ… Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!")
        return True
    except subprocess.CalledProcessError:
        print("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹!")
        return False

def create_env_file():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° .env"""
    print("\nâš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ...")
    
    if os.path.exists('.env'):
        print("ğŸ“„ Ğ¤Ğ°Ğ¹Ğ» .env ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚")
        overwrite = input("   ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ? (y/N): ").lower().strip()
        if overwrite != 'y':
            return True
    
    # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€
    if os.path.exists('.env.example'):
        shutil.copy('.env.example', '.env')
        print("âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ„Ğ°Ğ¹Ğ» .env Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ .env.example")
    else:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ .env
        with open('.env', 'w', encoding='utf-8') as f:
            f.write("# Telegram Bot Configuration\n")
            f.write("TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here\n\n")
            f.write("# Google Gemini API Configuration\n")
            f.write("GEMINI_API_KEY=your_gemini_api_key_here\n\n")
            f.write("# Database Configuration\n")
            f.write("DATABASE_PATH=./data/users.db\n")
        print("âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» .env")
    
    return True

def setup_api_keys():
    """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° API ĞºĞ»ÑÑ‡ĞµĞ¹"""
    print("\nğŸ”‘ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° API ĞºĞ»ÑÑ‡ĞµĞ¹...")
    print("   Ğ’Ğ°Ğ¼ Ğ¿Ğ¾Ğ½Ğ°Ğ´Ğ¾Ğ±ÑÑ‚ÑÑ:")
    print("   1. Telegram Bot Token (Ğ¾Ñ‚ @BotFather)")
    print("   2. Google Gemini API Key (Ğ¾Ñ‚ Google AI Studio)")
    print()
    
    setup_now = input("   ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ? (y/N): ").lower().strip()
    
    if setup_now == 'y':
        # Telegram Bot Token
        telegram_token = input("   Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Telegram Bot Token: ").strip()
        
        # Gemini API Key
        gemini_key = input("   Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Gemini API Key: ").strip()
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»
        with open('.env', 'r', encoding='utf-8') as f:
            content = f.read()
        
        content = content.replace('your_telegram_bot_token_here', telegram_token)
        content = content.replace('your_gemini_api_key_here', gemini_key)
        
        with open('.env', 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("âœ… API ĞºĞ»ÑÑ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹!")
    else:
        print("âš ï¸  ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒÑ‚Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ API ĞºĞ»ÑÑ‡Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğµ .env")
    
    return True

def create_directories():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹"""
    print("\nğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹...")
    
    directories = ['data', 'logs']
    
    for directory in directories:
        if not os.path.exists(directory):
            os.makedirs(directory)
            print(f"âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: {directory}")
        else:
            print(f"ğŸ“ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚: {directory}")
    
    return True

def final_check():
    """Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°"""
    print("\nğŸ” Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ .env
    if not os.path.exists('.env'):
        print("âŒ Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!")
        return False
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ .env
    with open('.env', 'r', encoding='utf-8') as f:
        env_content = f.read()
    
    if 'your_telegram_bot_token_here' in env_content:
        print("âš ï¸  Telegram Bot Token Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² .env")
    
    if 'your_gemini_api_key_here' in env_content:
        print("âš ï¸  Gemini API Key Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ² .env")
    
    print("âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!")
    return True

def print_instructions():
    """Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ"""
    print("\n" + "=" * 50)
    print("ğŸš€ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜ ĞŸĞ Ğ—ĞĞŸĞ£Ğ¡ĞšĞ£")
    print("=" * 50)
    print()
    print("1. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ API ĞºĞ»ÑÑ‡Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğµ .env:")
    print("   - TELEGRAM_BOT_TOKEN (Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ @BotFather)")
    print("   - GEMINI_API_KEY (Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ Google AI Studio)")
    print()
    print("2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°:")
    print("   python run.py")
    print("   Ğ¸Ğ»Ğ¸")
    print("   python main.py")
    print()
    print("3. ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ±Ğ¾Ñ‚Ğ° Ğ² Telegram Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ /start")
    print()
    print("ğŸ“š Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ² README.md")
    print("ğŸ› ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹? ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ logs/")
    print()

def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸"""
    print_header()
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python
    if not check_python_version():
        sys.exit(1)
    
    # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
    if not install_dependencies():
        sys.exit(1)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
    if not create_env_file():
        sys.exit(1)
    
    # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° API ĞºĞ»ÑÑ‡ĞµĞ¹
    if not setup_api_keys():
        sys.exit(1)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
    if not create_directories():
        sys.exit(1)
    
    # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
    if not final_check():
        sys.exit(1)
    
    # Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸
    print_instructions()

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\nâŒ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: {e}")
        sys.exit(1)